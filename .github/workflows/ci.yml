name: Backend CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install
        run: npm ci
      
      - name: Generate Prisma
        run: npx prisma generate
        env:
          DATABASE_URL: mysql://user:password@localhost:3306/academias_db
      
      - name: Validate Schema
        run: npx prisma validate
        env:
          DATABASE_URL: mysql://user:password@localhost:3306/academias_db
      
      - name: Lint
        run: npm run lint
      
      - name: Format Check
        run: npm run format:check
      
      - name: Build
        run: npm run build
      
      - name: Summary
        if: success()
        run: |
          echo "### [OK] Quality Check Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Todas las verificaciones de calidad pasaron correctamente." >> $GITHUB_STEP_SUMMARY

  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: quality-check
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: academias_db_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install
        run: npm ci
      
      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -u root -ptest_password --silent; then
              echo "[OK] MySQL ready"
              break
            fi
            sleep 2
          done
      
      - name: Setup Database
        run: |
          npx prisma generate
          npx prisma migrate deploy
          npx prisma db seed
        env:
          DATABASE_URL: mysql://root:test_password@127.0.0.1:3306/academias_db_test
          NODE_ENV: test
      
      - name: Run Tests
        run: npm test -- --coverage
        env:
          NODE_ENV: test
          DATABASE_URL: mysql://root:test_password@127.0.0.1:3306/academias_db_test
          JWT_SECRET: test_secret_key_minimum_32_characters_long
          JWT_REFRESH_SECRET: test_refresh_secret_key_minimum_32_chars
          JWT_EXPIRES_IN: 24h
          JWT_REFRESH_EXPIRES_IN: 7d
      
      - name: Coverage Report
        if: always()
        run: |
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(cat coverage/coverage-summary.json | grep -o '"lines":{"total":[0-9]*,"covered":[0-9]*,"skipped":[0-9]*,"pct":[0-9.]*' | grep -o 'pct":[0-9.]*' | cut -d':' -f2)
            echo "**Coverage:** ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Success
        if: success()
        run: |
          echo "### [OK] All Tests Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "El codigo esta listo para merge." >> $GITHUB_STEP_SUMMARY
